# 多语言翻译修复说明

## 问题背景

原有的字幕翻译工具只能翻译成中文，不支持翻译成日文或其他多语言。问题原因如下：

1. **配置硬编码**: `SubtitleConfig` 类中的 `target_language` 被硬编码为 "简体中文"
2. **参数未传递**: 命令行参数 `target_lang` 没有正确传递到翻译配置中
3. **缺少语言映射**: 需要建立从命令行简写到完整语言名称的映射

## 修复内容

### 1. 添加语言映射表

在 `src/subtitle_translator/translation_core/config.py` 中添加了完整的语言映射：

```python
LANGUAGE_MAPPING = {
    "zh": "简体中文",
    "zh-cn": "简体中文", 
    "zh-tw": "繁体中文",
    "ja": "日文",
    "japanese": "日文",
    "en": "English",
    "english": "English",
    "ko": "韩文",
    "korean": "韩文",
    "fr": "法文",
    "french": "法文",
    "de": "德文",
    "german": "德文",
    "es": "西班牙文",
    "spanish": "西班牙文",
    "pt": "葡萄牙文",
    "portuguese": "葡萄牙文",
    "ru": "俄文",
    "russian": "俄文",
    "it": "意大利文",
    "italian": "意大利文",
    "ar": "阿拉伯文",
    "arabic": "阿拉伯文",
    "th": "泰文",
    "thai": "泰文",
    "vi": "越南文",
    "vietnamese": "越南文",
}
```

### 2. 添加语言设置方法

为 `SubtitleConfig` 类添加了 `set_target_language` 方法：

```python
def set_target_language(self, lang_code: str) -> None:
    """设置目标语言"""
    self.target_language = get_target_language(lang_code)
```

### 3. 修复参数传递

修改了 `SubtitleTranslatorService` 类的初始化逻辑，确保命令行参数能正确传递：

```python
def _init_translation_env(self, target_lang: str = "zh", llm_model: Optional[str] = None) -> None:
    """初始化翻译环境并测试连接"""
    # 设置目标语言
    try:
        self.config.set_target_language(target_lang)
        logger.info(f"🌐 目标语言: {self.config.target_language}")
    except ValueError as e:
        logger.error(f"语言设置错误: {e}")
        raise
```

### 4. 改进命令行帮助

更新了命令行参数的帮助信息，详细列出支持的语言：

```python
target_lang: str = typer.Option("zh", "--target_lang", "-t", 
    help="目标翻译语言。支持的语言: zh(简体中文), zh-tw(繁体中文), ja(日文), en(英文), ko(韩文), fr(法文), de(德文), es(西班牙文), pt(葡萄牙文), ru(俄文), it(意大利文), ar(阿拉伯文), th(泰文), vi(越南文)。")
```

### 5. 添加参数验证

在主函数中添加了语言参数验证：

```python
# 验证目标语言参数
try:
    target_language = get_target_language(target_lang)
    logger.info(f"✅ 目标语言: {target_language}")
except ValueError as e:
    logger.error(f"❌ {e}")
    print(f"[bold red]❌ {e}[/bold red]")
    supported_langs = ", ".join(sorted(set(LANGUAGE_MAPPING.keys())))
    print(f"[yellow]💡 支持的语言代码: {supported_langs}[/yellow]")
    raise typer.Exit(code=1)
```

## 使用示例

现在你可以使用以下命令将字幕翻译成不同的语言：

```bash
# 翻译成日文
subtitle-translate -i video.srt -t ja

# 翻译成韩文
subtitle-translate -i video.srt -t ko

# 翻译成法文
subtitle-translate -i video.srt -t fr

# 翻译成德文
subtitle-translate -i video.srt -t de

# 翻译成繁体中文
subtitle-translate -i video.srt -t zh-tw

# 查看支持的语言
subtitle-translate --help
```

## 支持的语言列表

| 语言代码 | 语言名称 | 备注 |
|---------|---------|------|
| zh | 简体中文 | 默认语言 |
| zh-cn | 简体中文 | 与 zh 相同 |
| zh-tw | 繁体中文 | |
| ja, japanese | 日文 | |
| en, english | English | |
| ko, korean | 韩文 | |
| fr, french | 法文 | |
| de, german | 德文 | |
| es, spanish | 西班牙文 | |
| pt, portuguese | 葡萄牙文 | |
| ru, russian | 俄文 | |
| it, italian | 意大利文 | |
| ar, arabic | 阿拉伯文 | |
| th, thai | 泰文 | |
| vi, vietnamese | 越南文 | |

## 测试验证

### 语言映射测试

运行测试脚本验证语言映射功能：

```bash
python3 test_multilang.py
```

预期输出：
```
🔍 测试语言映射功能...
📋 支持的语言代码: ar, arabic, de, en, english, es, fr, ...

✅ zh       -> 简体中文
✅ ja       -> 日文
✅ japanese -> 日文
✅ en       -> English
✅ ko       -> 韩文
...

📊 测试结果: 10/10 通过
```

### CLI 参数验证测试

```bash
python3 test_translation_config.py
```

CLI 参数处理部分应该全部通过：
```
🔍 测试 CLI 参数处理...
✅ CLI 参数 ja -> 日文
✅ CLI 参数 en -> English
✅ CLI 参数 ko -> 韩文
✅ CLI 参数 fr -> 法文

📊 CLI 测试结果: 4/4 通过
```

## 修复效果

✅ **问题已解决**: 现在可以将字幕翻译成14种不同的语言  
✅ **向后兼容**: 默认仍然是简体中文，不影响现有用户  
✅ **用户友好**: 清晰的错误提示和帮助信息  
✅ **代码质量**: 添加了完整的参数验证和错误处理  

现在工具已经支持完整的多语言翻译功能！