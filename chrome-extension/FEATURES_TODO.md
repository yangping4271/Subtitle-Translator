# YouTube双语字幕扩展 - 功能开发计划

## 🎯 项目核心特性

### 统一转录架构 ✅
**YouTube视频不管有没有字幕，都使用本项目的转录、翻译技术，最后显示双语字幕**

- ✅ **完全独立**: 不依赖YouTube原生字幕，始终使用本项目转录
- ✅ **双重优化**: 额外下载YouTube字幕用于辅助优化翻译质量  
- ✅ **音频优先**: 优先下载音频，失败时下载视频提取音频
- ✅ **智能缓存**: 音频和字幕文件自动缓存，支持手动上传
- ✅ **Chrome Cookies**: 使用浏览器cookies绕过地域下载限制

## 🎯 当前开发任务（优先级高）

### 1. 字幕预加载翻译系统 ✅
**目标**: 实现零延迟高质量双语字幕显示

#### 1.1 后端转录统一入口（替代前端获取） ✅
- [x] 浏览器插件改为“始终调用本机后端转录”，不再在前端拉取/解析字幕
- [x] 后端接口（约定）：`/transcribe`、`/jobs/{id}/state`、`/segments`
- [x] 插件启动即提交转录任务，按播放窗口增量拉取 segments

#### 1.2 集成本项目翻译架构 ✅
- [x] 移植断句功能 **（架构优化）**
  - ✅ 从Python `spliter.py` 移植语义分割逻辑
  - ✅ 实现JavaScript版本的智能断句算法  
  - ✅ 保持技术术语和专有名词完整性
  - 📝 **重要**: 断句功能仅用于单词级时间戳字幕，段落字幕直接翻译
- [x] 移植总结分析功能
  - ✅ 从Python `summarizer.py` 移植内容分析
  - ✅ 提取视频主题、术语表、上下文信息
  - ✅ 为翻译质量优化提供全局信息
- [x] 实现分批翻译处理
  - ✅ 从Python `optimizer.py` 移植批处理逻辑
  - ✅ 优化批次大小和并行度（50条/批，3并发）
  - ✅ 实现翻译进度反馈

#### 1.3 预翻译处理系统 ✅
- [x] 后台异步翻译引擎
  - ✅ 在用户观看视频时后台处理翻译
  - ✅ 实现翻译任务队列和调度
  - ✅ 支持翻译过程中的视频操作
- [x] 翻译进度和状态管理
  - ✅ 显示翻译进度和状态（调试面板）
  - ✅ 实时反馈翻译状态（排队/处理中/完成）
  - ✅ 支持错误统计和日志导出
- [x] 智能缓存系统 ✅ **（已完成）**
  - ✅ 音频文件自动缓存和复用
  - ✅ 字幕文件缓存用于翻译优化
  - ✅ 支持手动上传音频到缓存
  - ✅ 完整的缓存管理API
  - ✅ 缓存状态查询和清理功能

#### 1.4 实时同步显示系统 🔄
- [x] 时间轴精确匹配
  - ✅ 基于视频播放时间匹配翻译内容
  - ✅ 支持亚秒级精度的时间对齐（500ms检查间隔）
  - [ ] 处理字幕时间偏移和同步问题 **（待优化）**
- [x] 播放控制适配
  - ✅ 支持暂停等基本操作
  - [ ] 处理播放速度变化的字幕同步
  - [ ] 支持章节跳转和时间点定位
- [x] 渲染性能优化
  - ✅ 优化DOM操作提升流畅度
  - ✅ 减少不必要的重渲染
  - [ ] 实现懒加载和虚拟滚动（大量字幕时）

---

## 🔧 音频缓存与下载策略 ✅ **（已完成）**

### 下载策略优化 ✅
- ✅ **音频优先**: 优先下载音频，仅在音频不可用时下载视频提取音频
- ✅ **Chrome Cookies**: 使用浏览器cookies绕过地域限制
- ✅ **多重回退**: 音频下载 → 视频+音频提取 → 仅视频下载
- ✅ **详细进度**: 显示每个下载阶段的具体状态

### 缓存系统架构 ✅
- ✅ **自动缓存**: 下载成功的音频和字幕自动缓存
- ✅ **手动上传**: 支持手动上传音频文件到缓存
- ✅ **缓存复用**: 相同视频自动使用缓存，跳过下载
- ✅ **文件管理**: 完整的缓存查询、清理、状态API

### 手动下载工作流 ✅
**当自动下载失败时的备用方案**:

1. **手动下载音频**
   ```bash
   yt-dlp --extract-audio --audio-format m4a --cookies-from-browser chrome \
     --geo-bypass "https://www.youtube.com/watch?v=VIDEO_ID"
   ```

2. **上传到缓存**
   ```bash
   curl -X POST "http://127.0.0.1:9009/cache/upload_audio/VIDEO_ID" \
     -F "file=@audio_file.m4a"
   ```

3. **刷新页面**: 插件自动检测缓存并使用

### 字幕辅助优化 ✅
- ✅ **双重下载**: 同时下载音频和YouTube原生字幕
- ✅ **翻译优化**: 使用原生字幕优化转录和翻译质量
- ✅ **上下文增强**: 为LLM提供更多上下文信息

---

## 🔧 技术问题修复记录 ✅ **（已解决）**

### 问题1: Chrome插件等待后端问题 ✅
**问题**: 插件一直显示"等待后端完成音频下载和翻译..."
**解决方案**:
- ✅ 添加详细的后端状态追踪和错误报告
- ✅ 实现10分钟超时保护机制
- ✅ 优化轮询间隔（2秒）减少服务器压力
- ✅ 增强错误处理和用户反馈

### 问题2: 音频下载失败问题 ✅
**解决方案**:
- ✅ 使用Chrome cookies绕过访问限制
- ✅ 实现音频优先下载策略
- ✅ 添加多重回退下载方案
- ✅ 支持手动音频上传备用方案

### 问题3: 调试和日志系统 ✅
- ✅ 增强的日志导出功能（Ctrl+L）
- ✅ 快捷键支持（Ctrl+D切换调试面板）
- ✅ 错误统计和详细状态显示
- ✅ 完整的系统信息收集

---

## ⚠️ 使用注意事项与兼容性

### 广告/隐私拦截器干扰（重要）
部分广告/隐私拦截扩展会拦截 YouTube 字幕接口（常见现象：`ERR_CONNECTION_CLOSED`、响应长度 0 字符、timedtext/json3 空响应）。

- 解决办法：
  - 优先在测试时临时关闭拦截器，或
  - 将以下域名加入例外白名单：
    - `https://www.youtube.com/api/timedtext`
    - `https://www.youtube.com/youtubei/v1/player`
    - `https://www.youtube.com/youtubei/v1/get_transcript`
    - `https://i.ytimg.com`
    - `https://*.googlevideo.com`

### 翻译 API 跨域
- 已默认代理以下主机，内容脚本会自动通过后台代理发起请求：
  - `https://ai-proxy.chatwise.app/openrouter/api/v1`
  - `https://openrouter.ai/api/v1`
- 如使用其它主机，需要在 `manifest.json` 的 `host_permissions` 中新增对应域名。

### 懒加载翻译策略
- 仅预译首批（默认 `batchSize=30`），播放中当距离下一批开始 ≤ 8 秒时后台触发翻译，实时回填显示。

### 总结（Summary）策略
- 总结成功且非空才使用；失败或返回空时按“无总结”处理（不中断流程，翻译质量可能略降）。

---

## 🎉 已完成功能

### 1. 完整双语字幕解决方案 ✅
**状态**: 已完成并测试通过

#### 1.1 三种双语字幕方案 ✅
- ✅ **ASS双语文件**: 专业播放器双语显示（青色英文 + 绿色翻译）
- ✅ **SRT中间文件**: 保留英文(.en.srt)和翻译(.zh.srt)分离文件
- ✅ **Chrome实时显示**: 网页端实时双语字幕（白色英文 + 黄色翻译）

#### 1.2 智能翻译缓存系统 ✅
- ✅ **三级缓存架构**: 音频缓存 + 字幕缓存 + 翻译缓存
- ✅ **翻译缓存命中**: 几秒内完成加载，大幅提升体验
- ✅ **自动缓存管理**: 翻译完成后自动保存所有生成文件
- ✅ **缓存API完整**: 查看、检查、清除缓存的完整接口

#### 1.3 Chrome扩展双模式 ✅
- ✅ **SRT双语模式**: 优先使用高质量的保留SRT文件
- ✅ **Segments模式**: 实时处理模式作为回退方案
- ✅ **智能回退机制**: SRT模式失败时自动降级到Segments模式
- ✅ **API端点统一**: 修复请求格式不匹配问题

#### 1.4 后端服务重建 ✅
- ✅ **完整FastAPI服务**: 支持完整翻译流程的专业后端
- ✅ **标准化API**: `/translate_youtube`, `/job_status/{id}`, `/srt_files/{id}`
- ✅ **错误处理增强**: 文件存在性检查、超时机制、异常处理
- ✅ **SRT文件优先**: 直接使用SRT文件避免复杂ASS解析

---

## 🎨 未来功能开发（优先级中等）

### 2. 字幕显示优化功能
**预计开发时间**: 双语字幕系统稳定后

#### 2.1 覆盖原生YouTube字幕 ⏳
- [ ] 检测和隐藏YouTube原生字幕
  - 找到并隐藏`.ytp-caption-window-container`容器
  - 确保原生字幕完全不显示
  - 处理不同YouTube界面版本的兼容性
- [ ] 精确位置对齐
  - 将双语字幕定位到原生字幕精确位置
  - 适配全屏模式和窗口模式的位置变化
  - 处理不同屏幕尺寸和分辨率的适配
- [ ] 字幕样式优化
  - 匹配YouTube原生字幕的视觉风格
  - 支持用户自定义字幕样式
  - 优化双语字幕的布局和间距

#### 2.2 可拖拽位置调节 ⏳
- [ ] 拖拽功能实现
  - 为字幕容器添加拖拽手柄
  - 实现鼠标/触摸拖拽事件处理
  - 添加拖拽边界限制，防止拖出屏幕
- [ ] 视觉反馈优化
  - 拖拽时的半透明效果和高亮边框
  - 显示位置网格线辅助对齐
  - 拖拽完成后的确认动画
- [ ] 位置持久化存储
  - 将用户自定义位置保存到Chrome Storage
  - 支持每个视频的独立位置记忆
  - 提供"重置到默认位置"功能
- [ ] 设置界面集成
  - 在popup设置中添加位置控制选项
  - 提供预设位置选择（顶部/中心/底部）
  - 支持数值输入精确定位

---

## 🔧 技术改进计划（优先级低）

### 3. 用户体验优化
- [ ] 多语言界面支持
- [ ] 字幕样式主题系统
- [ ] 快捷键操作支持
- [ ] 字幕搜索和跳转功能

### 4. 性能和稳定性
- [ ] 内存使用优化
- [x] 错误监控与日志导出（Ctrl+L）
- [x] 调试面板状态信息/错误统计
- [ ] 兼容性测试和修复
- [ ] 自动更新和版本管理

### 5. 高级功能
- [ ] 离线翻译支持
- [ ] 多字幕轨道切换
- [ ] 字幕导出和分享
- [ ] 翻译质量评分和优化

---

## 📋 开发里程碑

### 里程碑 1: 预翻译系统 (当前)
- ✅ 完成基础翻译功能
- ✅ 统一为“后端转录→（增量）总结→（增量）翻译”的架构
- ✅ 前端仅做显示与调度，按需增量拉取与懒加载翻译
- ⏳ 实现零延迟字幕显示

### 里程碑 2: 显示优化 (未来)
- ⏳ 覆盖原生字幕功能
- ⏳ 可拖拽位置调节
- ⏳ 用户自定义样式

### 里程碑 3: 功能完善 (远期)
- ⏳ 高级用户体验功能
- ⏳ 性能优化和稳定性
- ⏳ 扩展功能和生态

---

## 📝 开发注意事项

1. **代码质量**: 保持代码简洁和可维护性
2. **用户体验**: 优先考虑流畅性和直观性
3. **性能优化**: 注意内存使用和API调用频率
4. **错误处理**: 完善的异常处理和用户反馈
5. **兼容性**: 支持不同版本的YouTube界面
6. **隐私安全**: 遵守用户数据保护原则

---

*最后更新时间: 2025-08-11*  
*当前版本: v1.0.0*