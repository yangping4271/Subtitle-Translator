# YouTube双语字幕扩展 - 功能开发计划

## 🎯 当前开发任务（优先级高）

### 1. 字幕预加载翻译系统 
**目标**: 实现零延迟高质量双语字幕显示

#### 1.1 YouTube字幕数据获取 🔄 
- [x] 实现YouTube字幕轨道检测
  - ✅ 分析视频页面获取字幕轨道信息（33个轨道检测成功）
  - ✅ 支持自动字幕和手动字幕检测
  - ✅ 获取字幕语言列表
- [x] 实现完整字幕数据下载（多格式并行+择优）
  - ✅ JSON解析失败时自动回退 XML/SRT/VTT
  - ✅ SRV3/TTML 通用 XML 解析 + 专用回退
  - ✅ 构建时间轴数据结构
- [x] 错误处理和备用方案
  - ✅ 字幕不可用时回退到实时检测模式
  - ✅ 处理私有视频和受限内容

#### 1.2 集成本项目翻译架构 ✅
- [x] 移植断句功能 **（架构优化）**
  - ✅ 从Python `spliter.py` 移植语义分割逻辑
  - ✅ 实现JavaScript版本的智能断句算法  
  - ✅ 保持技术术语和专有名词完整性
  - 📝 **重要**: 断句功能仅用于单词级时间戳字幕，段落字幕直接翻译
- [x] 移植总结分析功能
  - ✅ 从Python `summarizer.py` 移植内容分析
  - ✅ 提取视频主题、术语表、上下文信息
  - ✅ 为翻译质量优化提供全局信息
- [x] 实现分批翻译处理
  - ✅ 从Python `optimizer.py` 移植批处理逻辑
  - ✅ 优化批次大小和并行度（50条/批，3并发）
  - ✅ 实现翻译进度反馈

#### 1.3 预翻译处理系统 ✅
- [x] 后台异步翻译引擎
  - ✅ 在用户观看视频时后台处理翻译
  - ✅ 实现翻译任务队列和调度
  - ✅ 支持翻译过程中的视频操作
- [x] 翻译进度和状态管理
  - ✅ 显示翻译进度和状态（调试面板）
  - ✅ 实时反馈翻译状态（排队/处理中/完成）
  - ✅ 支持错误统计和日志导出
- [ ] 本地缓存系统 **（未来优化）**
  - [ ] 翻译结果的持久化存储
  - [ ] 视频级别的缓存管理
  - [ ] 缓存大小限制和清理策略

#### 1.4 实时同步显示系统 🔄
- [x] 时间轴精确匹配
  - ✅ 基于视频播放时间匹配翻译内容
  - ✅ 支持亚秒级精度的时间对齐（500ms检查间隔）
  - [ ] 处理字幕时间偏移和同步问题 **（待优化）**
- [x] 播放控制适配
  - ✅ 支持暂停等基本操作
  - [ ] 处理播放速度变化的字幕同步
  - [ ] 支持章节跳转和时间点定位
- [x] 渲染性能优化
  - ✅ 优化DOM操作提升流畅度
  - ✅ 减少不必要的重渲染
  - [ ] 实现懒加载和虚拟滚动（大量字幕时）

---

## 🔧 当前技术问题修复 **（紧急）**

### 问题1: JSON解析错误 ✅（已通过多格式回退与诊断加固）
**方案**: 统一 text 读取 → JSON 失败回退 XML/SRT/VTT → 质量验证与择优

### 问题2: 断句逻辑优化 ✅
**当前状态**: 所有字幕都进行断句处理
**优化目标**: 仅对单词级时间戳字幕进行断句
**实现方案**:
- ✅ 检测字幕类型（段落 vs 单词级）
- ✅ 段落字幕跳过断句，直接翻译
- ✅ 单词级字幕启用智能断句
- ✅ 添加字幕类型识别日志

### 问题3: 调试和日志系统 ✅
- [x] 增强的日志导出功能
- [x] 快捷键支持（Ctrl+L导出，Ctrl+D切换面板）
- [x] 错误统计显示
- [x] 系统信息收集

---

## ⚠️ 使用注意事项与兼容性

### 广告/隐私拦截器干扰（重要）
部分广告/隐私拦截扩展会拦截 YouTube 字幕接口（常见现象：`ERR_CONNECTION_CLOSED`、响应长度 0 字符、timedtext/json3 空响应）。

- 解决办法：
  - 优先在测试时临时关闭拦截器，或
  - 将以下域名加入例外白名单：
    - `https://www.youtube.com/api/timedtext`
    - `https://www.youtube.com/youtubei/v1/player`
    - `https://www.youtube.com/youtubei/v1/get_transcript`
    - `https://i.ytimg.com`
    - `https://*.googlevideo.com`

### 翻译 API 跨域
- 已默认代理以下主机，内容脚本会自动通过后台代理发起请求：
  - `https://ai-proxy.chatwise.app/openrouter/api/v1`
  - `https://openrouter.ai/api/v1`
- 如使用其它主机，需要在 `manifest.json` 的 `host_permissions` 中新增对应域名。

### 懒加载翻译策略
- 仅预译首批（默认 `batchSize=30`），播放中当距离下一批开始 ≤ 8 秒时后台触发翻译，实时回填显示。

### 总结（Summary）策略
- 总结成功且非空才使用；失败或返回空时按“无总结”处理（不中断流程，翻译质量可能略降）。

---

## 🎨 未来功能开发（优先级中等）

### 2. 字幕显示优化功能
**预计开发时间**: 预翻译系统完成后

#### 2.1 覆盖原生YouTube字幕 ⏳
- [ ] 检测和隐藏YouTube原生字幕
  - 找到并隐藏`.ytp-caption-window-container`容器
  - 确保原生字幕完全不显示
  - 处理不同YouTube界面版本的兼容性
- [ ] 精确位置对齐
  - 将双语字幕定位到原生字幕精确位置
  - 适配全屏模式和窗口模式的位置变化
  - 处理不同屏幕尺寸和分辨率的适配
- [ ] 字幕样式优化
  - 匹配YouTube原生字幕的视觉风格
  - 支持用户自定义字幕样式
  - 优化双语字幕的布局和间距

#### 2.2 可拖拽位置调节 ⏳
- [ ] 拖拽功能实现
  - 为字幕容器添加拖拽手柄
  - 实现鼠标/触摸拖拽事件处理
  - 添加拖拽边界限制，防止拖出屏幕
- [ ] 视觉反馈优化
  - 拖拽时的半透明效果和高亮边框
  - 显示位置网格线辅助对齐
  - 拖拽完成后的确认动画
- [ ] 位置持久化存储
  - 将用户自定义位置保存到Chrome Storage
  - 支持每个视频的独立位置记忆
  - 提供"重置到默认位置"功能
- [ ] 设置界面集成
  - 在popup设置中添加位置控制选项
  - 提供预设位置选择（顶部/中心/底部）
  - 支持数值输入精确定位

---

## 🔧 技术改进计划（优先级低）

### 3. 用户体验优化
- [ ] 多语言界面支持
- [ ] 字幕样式主题系统
- [ ] 快捷键操作支持
- [ ] 字幕搜索和跳转功能

### 4. 性能和稳定性
- [ ] 内存使用优化
- [x] 错误监控与日志导出（Ctrl+L）
- [x] 调试面板状态信息/错误统计
- [ ] 兼容性测试和修复
- [ ] 自动更新和版本管理

### 5. 高级功能
- [ ] 离线翻译支持
- [ ] 多字幕轨道切换
- [ ] 字幕导出和分享
- [ ] 翻译质量评分和优化

---

## 📋 开发里程碑

### 里程碑 1: 预翻译系统 (当前)
- ✅ 完成基础翻译功能
- ✅ 实现字幕预加载和批量翻译（并发/择优/回退）
- ✅ 集成本项目的翻译架构（断句/总结/分批）
- ⏳ 实现零延迟字幕显示

### 里程碑 2: 显示优化 (未来)
- ⏳ 覆盖原生字幕功能
- ⏳ 可拖拽位置调节
- ⏳ 用户自定义样式

### 里程碑 3: 功能完善 (远期)
- ⏳ 高级用户体验功能
- ⏳ 性能优化和稳定性
- ⏳ 扩展功能和生态

---

## 📝 开发注意事项

1. **代码质量**: 保持代码简洁和可维护性
2. **用户体验**: 优先考虑流畅性和直观性
3. **性能优化**: 注意内存使用和API调用频率
4. **错误处理**: 完善的异常处理和用户反馈
5. **兼容性**: 支持不同版本的YouTube界面
6. **隐私安全**: 遵守用户数据保护原则

---

*最后更新时间: 2025-08-11*  
*当前版本: v1.0.0*