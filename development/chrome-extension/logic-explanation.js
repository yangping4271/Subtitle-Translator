// 字幕获取和翻译逻辑详解

/* 
=== 字幕获取逻辑流程 ===

1. 【页面监听】
   - 使用 MutationObserver 监听页面DOM变化
   - 监听多个可能的字幕容器选择器：
     * .caption-window .captions-text (新版YouTube)
     * .ytp-caption-segment (旧版YouTube) 
     * .caption-window (通用)
     * .html5-captions-text (备用)
     * .ytp-caption-window-container .captions-text (最新版)

2. 【触发检查】
   - DOM变化时触发检查
   - 每2秒定期检查(备用方案)
   - 页面加载后3秒首次检查

3. 【字幕提取】
   getCurrentSubtitle() 方法:
   - 遍历所有可能的选择器
   - 查找有内容的元素
   - 提取 textContent 并清理空白字符
   - 返回第一个找到的有效字幕文本

4. 【变化检测】
   - 与上次字幕文本比较
   - 如果内容改变，触发翻译
   - 如果字幕消失，清空显示

=== 翻译逻辑流程 ===

1. 【缓存检查】
   - 首先检查翻译缓存 Map
   - 如果已翻译过相同文本，直接使用缓存

2. 【API调用】
   - 构建翻译提示词
   - 调用 OpenAI Compatible API
   - 使用 POST /chat/completions 接口

3. 【提示词结构】
   系统提示词包含：
   - 角色定义：专业字幕翻译专家
   - 翻译要求：准确、自然、简洁
   - 目标语言：用户配置的语言
   - 术语对照表：技术词汇标准翻译
   
   用户输入：待翻译的字幕文本

4. 【结果处理】
   - 解析API响应
   - 缓存翻译结果
   - 更新页面显示

=== 显示逻辑 ===

1. 【容器创建】
   - 在YouTube播放器内创建绝对定位的字幕容器
   - 位置：视频底部居中，距离底部80px

2. 【双语显示】
   - 原文：白色，18px
   - 译文：黄色，16px，粗体
   - 背景：半透明黑色
   - 文字阴影增加可读性

=== 潜在问题点 ===

1. 【选择器失效】
   - YouTube经常更新页面结构
   - 字幕元素的class名称可能变化
   - 解决：使用多个备用选择器

2. 【时机问题】
   - 页面加载时字幕元素可能未出现
   - 字幕动态加载时机不确定
   - 解决：延迟初始化 + 重试机制

3. 【权限问题】
   - API调用可能被CORS阻止
   - 解决：在manifest中声明host_permissions

4. 【频率限制】
   - API调用过于频繁可能被限制
   - 解决：缓存机制 + 防抖动

*/